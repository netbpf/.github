name: CodeQL Dashboard

on:
  workflow_run:
    workflows: ["CodeQL Security Analysis"]
    types:
      - completed
  schedule:
    - cron: '0 0 * * *'  # Daily at midnight
  workflow_dispatch:

jobs:
  generate-dashboard:
    name: Generate and Publish Dashboard
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          ref: 'gh-pages'
          persist-credentials: false
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml requests
      
      - name: Download latest scan results
        uses: actions/download-artifact@v3
        with:
          name: codeql-results
          path: results
      
      - name: Run analysis script
        run: |
          mkdir -p .github/scripts
          cp .github/scripts/monitor-codeql-results.py .
          python monitor-codeql-results.py --results-dir results --output dashboard/data/latest-scan.json
      
      - name: Generate dashboard
        run: |
          mkdir -p dashboard
          cp .github/scripts/codeql-dashboard.html dashboard/index.html
          
          # Generate a simple data file if no scan results
          if [ ! -f "dashboard/data/latest-scan.json" ]; then
            mkdir -p dashboard/data
            echo '{"summary": {"total_findings": 0, "by_severity": {"critical": 0, "high": 0, "medium": 0, "low": 0}, "by_language": {}}, "findings": {"critical": [], "high": [], "medium": [], "low": []}}' > dashboard/data/latest-scan.json
          fi
      
      - name: Deploy to GitHub Pages
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/gh-pages'
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: dashboard
          branch: gh-pages
          clean: true
          clean-exclude: |
            data/
            *.json
          commit-message: 'Deploy CodeQL Dashboard [skip ci]'
          target-folder: ''
