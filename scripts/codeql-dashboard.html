<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NETBPF - CodeQL Security Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --danger: #e74c3c;
            --warning: #f39c12;
            --success: #2ecc71;
            --light: #ecf0f1;
            --dark: #2c3e50;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f7fa;
            color: var(--dark);
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        header {
            background: var(--primary);
            color: white;
            padding: 1rem 2rem;
            border-radius: 8px;
            margin-bottom: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 2rem;
        }
        
        .card {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .card-header {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--primary);
            border-bottom: 1px solid #eee;
            padding-bottom: 0.5rem;
        }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 1rem;
        }
        
        .metric-card {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 6px;
            text-align: center;
        }
        
        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            margin: 0.5rem 0;
        }
        
        .critical { color: var(--danger); }
        .high { color: var(--warning); }
        .medium { color: #f1c40f; }
        .low { color: var(--success); }
        
        .findings-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        
        .findings-table th, .findings-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        .findings-table th {
            background: #f8f9fa;
            font-weight: 600;
        }
        
        .severity-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            display: inline-block;
        }
        
        .severity-critical { background: #fde8e8; color: var(--danger); }
        .severity-high { background: #fef3c7; color: #b45309; }
        .severity-medium { background: #fef9c3; color: #854d0e; }
        .severity-low { background: #ecfdf5; color: #047857; }
        
        .refresh-btn {
            background: var(--secondary);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            margin: 1rem 0;
        }
        
        .refresh-btn:hover {
            opacity: 0.9;
        }
        
        .last-updated {
            color: #666;
            font-size: 0.9rem;
            margin-top: 1rem;
            text-align: right;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>NETBPF Security Dashboard</h1>
            <p>CodeQL Scan Results and Security Metrics</p>
        </header>
        
        <div class="dashboard-controls">
            <button id="refreshBtn" class="refresh-btn">ðŸ”„ Refresh Data</button>
            <div class="last-updated" id="lastUpdated">Last updated: Loading...</div>
        </div>
        
        <div class="dashboard-grid">
            <div class="card">
                <div class="card-header">Scan Summary</div>
                <div class="metrics-grid">
                    <div class="metric-card">
                        <div>Total Findings</div>
                        <div class="metric-value" id="totalFindings">0</div>
                    </div>
                    <div class="metric-card">
                        <div>Critical</div>
                        <div class="metric-value critical" id="criticalFindings">0</div>
                    </div>
                    <div class="metric-card">
                        <div>High</div>
                        <div class="metric-value high" id="highFindings">0</div>
                    </div>
                    <div class="metric-card">
                        <div>Medium</div>
                        <div class="metric-value medium" id="mediumFindings">0</div>
                    </div>
                    <div class="metric-card">
                        <div>Low</div>
                        <div class="metric-value low" id="lowFindings">0</div>
                    </div>
                    <div class="metric-card">
                        <div>Scanned Repos</div>
                        <div class="metric-value" id="scannedRepos">0</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="dashboard-grid">
            <div class="card">
                <div class="card-header">Findings by Language</div>
                <canvas id="languageChart"></canvas>
            </div>
            <div class="card">
                <div class="card-header">Findings by Severity</div>
                <canvas id="severityChart"></canvas>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header">Recent Findings</div>
            <table class="findings-table" id="findingsTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Severity</th>
                        <th>Rule</th>
                        <th>Message</th>
                        <th>Location</th>
                    </tr>
                </thead>
                <tbody id="findingsTableBody">
                    <!-- Filled by JavaScript -->
                </tbody>
            </table>
        </div>
        
        <div class="card">
            <div class="card-header">Organization-Specific Checks</div>
            <div id="orgChecks">
                <!-- Filled by JavaScript -->
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const CONFIG = {
            apiEndpoint: 'https://api.github.com/repos/netbpf/.github/actions/artifacts',
            reportFile: 'codeql-analysis-report.json',
            refreshInterval: 300000, // 5 minutes
            orgChecks: {
                'bpf-helper-usage': 'Check for unsafe BPF helper function usage',
                'ebpf-map-access': 'Verify proper eBPF map access patterns',
                'memory-safety': 'Check for potential memory safety issues',
                'concurrency-issues': 'Identify potential race conditions',
                'crypto-weak': 'Detect weak cryptographic algorithms'
            },
            severityLevels: {
                'critical': { class: 'severity-critical', label: 'Critical' },
                'high': { class: 'severity-high', label: 'High' },
                'medium': { class: 'severity-medium', label: 'Medium' },
                'low': { class: 'severity-low', label: 'Low' }
            }
        };
        
        // Global variables
        let languageChart, severityChart;
        let reportData = null;
        
        // Initialize the dashboard
        document.addEventListener('DOMContentLoaded', () => {
            // Set up event listeners
            document.getElementById('refreshBtn').addEventListener('click', loadData);
            
            // Load initial data
            loadData();
            
            // Set up auto-refresh
            setInterval(loadData, CONFIG.refreshInterval);
        });
        
        // Load data from API
        async function loadData() {
            try {
                // In a real implementation, this would fetch from your API
                // For now, we'll use a sample response
                const response = await fetch(CONFIG.reportFile);
                if (!response.ok) throw new Error('Failed to load report');
                
                reportData = await response.json();
                updateDashboard();
                updateLastUpdated();
            } catch (error) {
                console.error('Error loading data:', error);
                alert('Failed to load data. See console for details.');
            }
        }
        
        // Update the dashboard with the latest data
        function updateDashboard() {
            if (!reportData) return;
            
            const { summary, findings } = reportData;
            
            // Update summary metrics
            document.getElementById('totalFindings').textContent = summary.total_findings;
            document.getElementById('criticalFindings').textContent = summary.by_severity.critical || 0;
            document.getElementById('highFindings').textContent = summary.by_severity.high || 0;
            document.getElementById('mediumFindings').textContent = summary.by_severity.medium || 0;
            document.getElementById('lowFindings').textContent = summary.by_severity.low || 0;
            document.getElementById('scannedRepos').textContent = Object.keys(summary.by_language).length;
            
            // Update charts
            updateCharts(summary);
            
            // Update findings table
            updateFindingsTable(findings);
            
            // Update organization checks
            updateOrgChecks();
        }
        
        // Update charts
        function updateCharts(summary) {
            // Language distribution chart
            const languageCtx = document.getElementById('languageChart').getContext('2d');
            const languageData = {
                labels: Object.keys(summary.by_language),
                datasets: [{
                    data: Object.values(summary.by_language),
                    backgroundColor: [
                        '#3498db', '#2ecc71', '#f1c40f', '#e74c3c', '#9b59b6',
                        '#1abc9c', '#f39c12', '#d35400', '#34495e', '#7f8c8d'
                    ]
                }]
            };
            
            if (languageChart) {
                languageChart.data = languageData;
                languageChart.update();
            } else {
                languageChart = new Chart(languageCtx, {
                    type: 'doughnut',
                    data: languageData,
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'right'
                            }
                        }
                    }
                });
            }
            
            // Severity distribution chart
            const severityCtx = document.getElementById('severityChart').getContext('2d');
            const severityData = {
                labels: Object.keys(summary.by_severity).map(s => s.charAt(0).toUpperCase() + s.slice(1)),
                datasets: [{
                    data: Object.values(summary.by_severity),
                    backgroundColor: [
                        '#e74c3c', // Critical
                        '#f39c12', // High
                        '#f1c40f', // Medium
                        '#2ecc71'  // Low
                    ]
                }]
            };
            
            if (severityChart) {
                severityChart.data = severityData;
                severityChart.update();
            } else {
                severityChart = new Chart(severityCtx, {
                    type: 'bar',
                    data: severityData,
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        },
                        plugins: {
                            legend: {
                                display: false
                            }
                        }
                    }
                });
            }
        }
        
        // Update findings table
        function updateFindingsTable(findings) {
            const tbody = document.getElementById('findingsTableBody');
            tbody.innerHTML = '';
            
            // Flatten findings by severity
            const allFindings = [
                ...(findings.critical || []).map(f => ({ ...f, severity: 'critical' })),
                ...(findings.high || []).map(f => ({ ...f, severity: 'high' })),
                ...(findings.medium || []).map(f => ({ ...f, severity: 'medium' })),
                ...(findings.low || []).map(f => ({ ...f, severity: 'low' }))
            ];
            
            // Sort by severity (critical first)
            const severityOrder = { critical: 0, high: 1, medium: 2, low: 3 };
            allFindings.sort((a, b) => severityOrder[a.severity] - severityOrder[b.severity]);
            
            // Add rows to table
            allFindings.slice(0, 50).forEach((finding, index) => {
                const tr = document.createElement('tr');
                const severity = CONFIG.severityLevels[finding.severity] || { class: '', label: 'Unknown' };
                
                tr.innerHTML = `
                    <td>${index + 1}</td>
                    <td><span class="severity-badge ${severity.class}">${severity.label}</span></td>
                    <td><code>${finding.rule_id || 'N/A'}</code></td>
                    <td>${finding.message || 'No message'}</td>
                    <td>${finding.location || 'N/A'}</td>
                `;
                
                tbody.appendChild(tr);
            });
        }
        
        // Update organization checks
        function updateOrgChecks() {
            const container = document.getElementById('orgChecks');
            container.innerHTML = '';
            
            Object.entries(CONFIG.orgChecks).forEach(([id, description]) => {
                const checkDiv = document.createElement('div');
                checkDiv.className = 'metric-card';
                checkDiv.innerHTML = `
                    <div style="font-weight: 600; margin-bottom: 0.5rem;">${description}</div>
                    <div style="display: flex; align-items: center;">
                        <div style="width: 20px; height: 20px; border-radius: 50%; background: #2ecc70; margin-right: 0.5rem;"></div>
                        <span>No issues found</span>
                    </div>
                `;
                
                container.appendChild(checkDiv);
            });
        }
        
        // Update last updated timestamp
        function updateLastUpdated() {
            const now = new Date();
            document.getElementById('lastUpdated').textContent = `Last updated: ${now.toLocaleString()}`;
        }
    </script>
</body>
</html>
